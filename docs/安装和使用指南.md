# 📖 安装和使用指南

## 🔧 环境准备

### 系统要求
- **操作系统**：Windows 7/8/10/11 (64位)
- **Python版本**：Python 3.8 或更高版本
- **内存要求**：建议 4GB 以上
- **磁盘空间**：至少 100MB 可用空间

### 依赖安装

1. **安装Python依赖**
```bash
pip install -r requirements.txt
```

2. **FFmpeg依赖**
程序使用项目bin目录中的FFmpeg，请确保以下文件存在：
- `bin/ffmpeg.exe` - 音视频处理引擎
- `bin/ffprobe.exe` - 媒体信息探测工具

## 🚀 快速启动

### 方法一：直接运行
```bash
python main.py
```

### 方法二：开发模式
```bash
cd refactor_project
python -m src.main_window
```

## 🎵 音频提取功能详解

### 基本使用流程

1. **启动软件**：运行 `main.py`
2. **激活软件**：首次使用需要输入手机号和激活码
3. **选择"音频提取"标签页**
4. **配置输入输出**：
   - 选择包含视频文件的文件夹
   - 选择音频输出位置（或勾选"导出到原文件夹"）
5. **调整设置**：
   - 保持原始目录结构：维持原有文件夹层次
   - 跳过已存在的文件：避免重复处理
   - 并发线程数：根据CPU性能调整（建议4-16个）
6. **开始处理**：点击"开始提取"
7. **监控进度**：观察进度条和日志信息

### 高级功能

#### 智能音频优化
软件会自动检测和处理以下情况：
- **伪立体声检测**：识别只有单声道的"假"立体声
- **单声道转换**：将单声道音频转换为真立体声
- **音量平衡**：自动分析左右声道音量

#### 格式兼容性处理
- **自动格式选择**：根据源音频编码选择最佳输出格式
- **智能转码**：不兼容格式自动转换为MP3
- **大文件处理**：超过500MB的文件自动压缩为MP3

#### 批量处理优化
- **多线程处理**：同时处理多个文件
- **暂停/恢复**：支持中途暂停和继续
- **错误恢复**：单个文件失败不影响整体进度

### 支持格式

#### 输入视频格式
| 格式 | 扩展名 | 支持程度 |
|------|--------|----------|
| MP4 | .mp4 | ✅ 完全支持 |
| AVI | .avi | ✅ 完全支持 |
| MKV | .mkv | ✅ 完全支持 |
| MOV | .mov | ✅ 完全支持 |
| WMV | .wmv | ✅ 完全支持 |
| FLV | .flv | ✅ 完全支持 |
| WebM | .webm | ✅ 完全支持 |
| M4V | .m4v | ✅ 完全支持 |
| 3GP | .3gp | ✅ 完全支持 |
| MTS/M2TS | .mts, .m2ts | ✅ 完全支持 |
| TS | .ts | ✅ 完全支持 |

#### 输出音频格式
| 格式 | 扩展名 | 特点 |
|------|--------|------|
| AAC | .aac | 高质量，小体积 |
| MP3 | .mp3 | 通用兼容性最好 |
| AC3 | .ac3 | 多声道支持 |
| FLAC | .flac | 无损压缩 |
| OGG | .ogg | 开源格式 |
| WAV | .wav | 无压缩原始格式 |

## 📝 字幕重命名功能详解

### 基本使用流程

1. **选择"字幕重命名"标签页**
2. **选择素材库文件夹**：包含视频和字幕文件
3. **可选启用时长匹配**：提高匹配准确性
4. **扫描文件**：点击"扫描并生成重命名计划"
5. **查看匹配结果**：在表格中预览重命名计划
6. **执行重命名**：确认无误后点击"开始重命名"
7. **验证结果**：检查重命名是否正确

### 智能匹配算法

#### 匹配优先级
1. **剧集编号匹配**（优先级最高）
   - S01E02、S1E2 格式
   - E02、EP02 格式
   - 第02集、02集 格式
   - 纯数字编号

2. **文件名模糊匹配**
   - 基于 rapidfuzz 算法
   - 相似度阈值：60%
   - 同目录文件优先（+5分加成）

3. **时长验证匹配**（可选）
   - 需要启用 FFprobe
   - 验证视频和字幕时长匹配度

#### 匹配规则详解

**剧集编号提取示例**：
```
剧名.S01E05.720p.mkv     → 提取编号: 5
Episode.05.中英字幕.srt   → 提取编号: 5
第5集.高清版.mp4         → 提取编号: 5
```

**模糊匹配示例**：
```
源文件: "复仇者联盟.终局之战.2019.mkv"
字幕:   "Avengers.Endgame.2019.srt"
相似度: 85% → 匹配成功
```

### 支持格式

#### 视频格式
所有音频提取功能支持的格式

#### 字幕格式
| 格式 | 扩展名 | 特点 |
|------|--------|------|
| SubRip | .srt | 最常用格式 |
| Advanced SSA | .ass | 支持特效样式 |
| SubStation Alpha | .ssa | 传统样式格式 |
| WebVTT | .vtt | Web标准格式 |
| SubViewer | .sub | 简单文本格式 |

### 操作安全性

#### 撤销机制
- **完整操作日志**：记录所有重命名操作
- **原子操作**：确保操作的完整性
- **一键撤销**：支持撤销最近一次批量操作
- **历史记录**：保存多次操作历史

#### 冲突处理
- **文件名冲突检测**：重命名前检查目标文件是否存在
- **安全跳过**：自动跳过可能导致冲突的操作
- **详细报告**：显示冲突文件列表和原因

## ⚙️ 高级配置

### 性能调优

#### 音频提取性能
```python
# 推荐线程数配置
CPU核心数 = 4   → 推荐线程数: 4-8
CPU核心数 = 8   → 推荐线程数: 8-16
CPU核心数 = 16  → 推荐线程数: 16-32
```

#### 内存优化建议
- **大文件处理**：处理大量大文件时适当减少线程数
- **系统资源**：保留至少25%系统资源给其他程序
- **磁盘IO**：SSD硬盘可以设置更多线程

### 文件组织建议

#### 推荐目录结构
```
素材库/
├── 剧集1/
│   ├── S01E01.mp4
│   ├── S01E01.srt
│   ├── S01E02.mp4
│   └── S01E02.srt
├── 剧集2/
│   ├── Episode.01.mkv
│   ├── Episode.01.ass
│   ├── Episode.02.mkv
│   └── Episode.02.ass
└── 电影/
    ├── 电影名.2023.mp4
    └── 电影名.2023.srt
```

#### 命名规范建议
- **保持一致性**：同一系列使用相同命名规范
- **包含关键信息**：剧集号、季数、分辨率等
- **避免特殊字符**：避免使用 `<>:"/\|?*` 等字符
- **使用通用格式**：推荐使用 S01E01 这样的标准格式

## 🔍 故障排除

### 常见问题

#### 音频提取问题

**问题：提取失败，提示"找不到音频流"**
- **原因**：视频文件可能损坏或不包含音频
- **解决**：使用其他播放器验证视频文件是否正常

**问题：提取速度很慢**
- **原因**：可能需要转码或线程数设置不当
- **解决**：
  1. 调整线程数（尝试4-8个）
  2. 检查是否为PCM音频（需要转码）
  3. 确保有足够磁盘空间

**问题：输出文件很大**
- **原因**：源音频为无损格式
- **解决**：软件会自动转换超过500MB的文件为MP3

#### 字幕重命名问题

**问题：匹配率很低**
- **原因**：文件命名规范不一致
- **解决**：
  1. 检查文件名是否包含剧集信息
  2. 启用时长匹配功能
  3. 手动调整文件名增加匹配信息

**问题：重命名后文件找不到**
- **原因**：重命名操作成功但路径变化
- **解决**：使用撤销功能恢复，然后检查目标目录

#### 激活问题

**问题：激活码验证失败**
- **原因**：输入错误或激活码已过期
- **解决**：
  1. 检查手机号格式（11位数字）
  2. 检查激活码格式（XXXX-XXXX-XXXX）
  3. 联系客服获取新激活码

**问题：激活状态保存失败**
- **原因**：权限不足或磁盘空间不足
- **解决**：
  1. 以管理员身份运行程序
  2. 清理磁盘空间
  3. 检查安全软件是否阻止

### 日志分析

#### 音频提取日志
```
[10:30:15] 开始处理，素材文件夹：E:\Videos
[10:30:16] 🎬 正在处理：example.mp4
[10:30:18] 成功：example.mp4 → .aac
[10:30:19] ⚠️ 检测到伪立体声，已转换成真立体声 (L:-12.3dB R:-45.6dB)
```

**日志说明**：
- `成功` - 处理成功
- `跳过` - 文件已存在
- `转码` - 格式转换成功
- `失败` - 处理失败
- `⚠️` - 检测到音频问题并已修复

#### 字幕重命名日志
- `编号匹配(E05)` - 通过剧集编号匹配
- `模糊匹配(相似度 85)` - 通过文件名相似度匹配
- `未匹配到视频，保留原名` - 没有找到对应视频

## 💡 使用技巧

### 提高效率的建议

1. **批量处理准备**
   - 整理好文件结构再开始处理
   - 清理无关文件，只保留需要处理的
   - 确保有足够磁盘空间

2. **性能优化**
   - 根据硬件配置调整线程数
   - 大文件处理时关闭其他占用资源的程序
   - 定期清理系统临时文件

3. **文件管理**
   - 使用标准化命名规范
   - 保持视频和字幕文件在相同目录
   - 定期备份重要文件

4. **故障预防**
   - 定期检查软件更新
   - 保持系统和驱动最新
   - 使用可靠的存储设备

---

如有其他问题，请查看 FAQ 或联系技术支持。




